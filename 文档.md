* # Python+PySide6 RPA系统：影刀功能完美复刻版技术白皮书

  ## 一、系统架构设计（影刀级工程实现）

  ### 1.1 核心技术栈

  - **UI框架**：PySide6.8.0（Qt6官方Python绑定，LGPL商业友好协议）
  - **自动化内核**：Playwright 1.40（浏览器）+ PyAutoGUI 0.9.54（桌面）+ Pywinauto（原生控件）
  - **任务调度**：APScheduler 3.10 + Croniter解析器
  - **数据持久化**：SQLite（流程元数据）+ JSON（元素库）+ HDF5（执行日志）
  - **打包部署**：PyInstaller 6.3 + Inno Setup（Windows服务化）

  ### 1.2 多进程隔离架构

  Python

  复制

  ```python
  # 主进程：PySide6 UI界面（Qt主事件循环）
  # 子进程1：Playwright自动化引擎（Chromium沙箱）
  # 子进程2：任务调度守护进程（APScheduler+Windows服务）
  # 子进程3：日志聚合服务（ZeroMQ消息总线）
  # 完全复刻影刀的"机器人服务"无人值守模式
  ```

  ------

  ## 二、可视化流程设计器（100%影刀操作体验）

  ### 2.1 拖拽式画布（基于QGraphicsScene）

  - **无限画布**：支持缩放(10%-400%)、网格对齐(10px)、节点对齐线
  - **节点类型**（精确复刻影刀图标与配色）：

  表格

  复制

  | 节点类型      | PySide6实现               | 影刀对标     | 属性面板动态控件                      |
  | :------------ | :------------------------ | :----------- | :------------------------------------ |
  | **打开网页**  | QGraphicsRectItem+SVG图标 | 绿色地球     | URL输入框+浏览器选择下拉框            |
  | **点击元素**  | 红色鼠标指针图标          | 红色鼠标     | 元素选择器+点击方式（单击/双击/右键） |
  | **输入文本**  | 蓝色键盘图标              | 蓝色键盘     | 文本输入框+输入模式（追加/覆盖）      |
  | **循环**      | 黄色回旋箭头              | 黄色循环     | 循环类型+次数/条件表达式              |
  | **判断**      | 紫色分叉图标              | 紫色判断     | 条件编辑器（支持Python三元表达式）    |
  | **延时等待**  | 橙色时钟图标              | 橙色等待     | 毫秒输入框+随机延迟范围               |
  | **Excel操作** | 绿色表格图标              | 绿色Excel    | 文件路径+Sheet+范围选择器             |
  | **异常处理**  | 红色盾牌图标              | 红色TryCatch | 重试次数+异常类型捕获                 |

  - **连线交互**：右键菜单"删除连线"、"编辑条件"（支持`变量名.exists()`等影刀语法）

  ### 2.2 命令参数面板（动态QFormLayout）

  选中节点后右侧属性区实时加载：

  Python

  复制

  ```python
  # 示例：点击元素节点的动态表单
  1. 元素选择方式 QComboBox: ["自动生成的选择器", "CSS选择器", "XPath", "图像匹配"]
  2. 选择器文本框 QLineEdit: 支持变量替换 {{变量名}}
  3. 点击方式 QComboBox: ["单击", "双击", "鼠标按下", "鼠标抬起"]
  4. 偏移量 QSpinBox: X/Y偏移（用于随机防检测）
  5. 等待超时 QSpinBox: 默认30秒
  6. 错误处理 QComboBox: ["抛出异常", "继续执行", "重试"]
  ```

  ------

  ## 三、智能元素捕获器（超越影刀的精确识别）

  ### 3.1 跨平台元素探测器

  - **激活方式**：F2键（全局热键注册，通过PySide6的QShortcut实现）
  - **Web捕获**：
    - 集成Playwright Inspector，悬浮时红色边框高亮
    - 自动生成选择器优先级：`data-testid > id > name > CSS > XPath > text`
    - 自动检测iframe层级，生成`frame_locator()`链式调用
  - **桌面捕获**：
    - 调用Pywinauto的`Desktop().from_point()`获取控件树
    - 对非标准控件自动降级为图像匹配，截屏保存模板
    - 生成唯一控件路径：`窗口句柄 > 控件类名 > 索引 > 坐标`

  ### 3.2 元素库管理（QTreeWidget实现）

  Python

  复制

  ```python
  元素库结构（影刀风格）：
  ├── Web元素库
  │   ├── 淘宝后台
  │   │   ├── 登录按钮 (selector: "#login-btn", type: css)
  │   │   ├── 用户名输入框 (selector: "#username", iframe: "main-frame")
  │   └── 京东订单页
  │       └── 订单号列表 (selector: ".order-list tr", dynamic: True)
  ├── 桌面元素库
  │   ├── 微信PC版
  │   │   ├── 搜索框 (class_name: "Edit", ctrl_index: 0)
  │   └── 金蝶ERP
  │       └── 查询按钮 (image: "assets/kingdee_search.png", confidence: 0.95)
  ```

  - **智能修复**：元素失效时自动尝试备用选择器（每元素可存3个备选）

  ------

  ## 四、任务调度中心（完美复刻影刀定时功能）

  ### 4.1 触发器类型（基于APScheduler深度定制）

  表格

  复制

  | 触发器         | UI配置界面                                 | 影刀对标   | Cron表达式支持 |
  | :------------- | :----------------------------------------- | :--------- | :------------- |
  | **立即执行**   | 按钮：QPushButton("运行")                  | ✅ 直接运行 | -              |
  | **一次执行**   | QDateTimeEdit（精确到秒）                  | ✅ 定时一次 | -              |
  | **循环执行**   | QSpinBox(间隔) + QComboBox(分/时/天)       | ✅ 循环间隔 | 简易模式       |
  | **Cron表达式** | QTextEdit + Cron可视化编辑器               | ✅ 高级定时 | 完整支持       |
  | **文件触发**   | QLineEdit(监控路径) + QComboBox(创建/修改) | ✅ 文件监控 | -              |
  | **邮件触发**   | POP3/IMAP配置表单                          | ✅ 邮件触发 | -              |
  | **API触发**    | Flask/FastAPI内嵌服务                      | ✅ Webhook  | -              |

  ### 4.2 Cron表达式可视化编辑器（PySide6自定义组件）

  Python

  复制

  ```python
  # 实现效果：点击"生成Cron"按钮弹出专用对话框
  对话框包含：
  ├── 分钟 (0-59)      QSpinBox + 多选QListWidget
  ├── 小时 (0-23)      QSpinBox + 多选QListWidget
  ├── 日期 (1-31)      QSpinBox + QComboBox["每天","工作日","周末"]
  ├── 月份 (1-12)      QSpinBox + QCheckBox["每月"]
  ├── 星期 (0-6)       QComboBox["周一","周二"...] + 多选
  └── 表达式预览 QLabel: "0 9 * * 1-5" (实时显示)
  
  高级选项：
  - 排除日期：QCalendarWidget多选节假日
  - 执行期限：QDateTimeEdit("结束时间")
  - 并发策略：QComboBox["串行排队","并行执行","跳过本次"]
  ```

  ### 4.3 日历排程视图（QCalendarWidget深度定制）

  - **月视图**：每个日期格子显示当天任务数量（数字角标）
  - **日视图**：Timeline时间轴，拖拽调整任务执行时间
  - **冲突检测**：自动标红重叠任务，提示"17:00-18:00已有任务A"
  - **执行历史**：日期下方小圆点表示成功(绿)/失败(红)/取消(灰)

  ### 4.4 多机器人管理（对标影刀"机器人服务"）

  Python

  复制

  ```python
  机器人配置表(QTableWidget):
  | 机器人名称 | 状态 | 最大并发 | 今日执行数 | 平均时长 | 操作按钮 |
  |-----------|------|----------|------------|----------|----------|
  | Robot-PC1 | 在线 | 5 | 23 | 45s | 编辑/暂停 |
  | Robot-VM01| 离线 | 3 | 0  | - | 启动服务 |
  
  服务化实现：
  - Windows: 注册为系统服务（winservice.py）
  - Linux: systemd服务文件生成
  - 开机自启：写入注册表Run键（Windows）或crontab（Linux）
  ```

  ------

  ## 五、流程控制引擎（影刀语法级兼容）

  ### 5.1 控制流节点（完全复刻）

  - **If判断**：支持可视化条件积木（拖拽变量+运算符+值）

    Python

    复制

    ```python
    # 生成的Python代码
    if {{订单金额}} > 1000 and "{{会员等级}}" == "VIP":
        # 真分支
    else:
        # 假分支
    ```

    

  - **For循环**：遍历列表/Excel行/文件夹文件

  - **While循环**：条件满足时持续执行（支持超时强制退出）

  - **Try-Catch**：异常类型下拉框（TimeoutError/ElementNotFound/通用Exception）

  - **延时等待**：固定时间/随机时间/等待元素出现或消失

  ### 5.2 变量管理（QTableView数据绑定）

  Python

  复制

  ```python
  变量管理器（影刀风格）：
  ├── 输入变量：流程运行前弹窗填写
  ├── 输出变量：流程结束后返回值
  ├── 全局变量：跨流程共享（存储于SQLite）
  └── 临时变量：流程内有效（自动GC）
  
  数据类型智能识别：
  - 文本: QLineEdit
  - 数字: QSpinBox/QDoubleSpinBox
  - 布尔: QCheckBox
  - 列表: QTextEdit（逗号分隔）
  - 文件/文件夹: QPushButton + QFileDialog
  - 日期: QDateTimeEdit
  
  变量替换引擎：{{变量名}} 语法，支持嵌套 {{外层.内层}}
  ```

  ------

  ## 六、调试与监控（影刀执行视图）

  ### 6.1 可视化调试器

  - **断点**：在节点上右键"设置断点"，红色圆点标记（QGraphicsEllipseItem）
  - **单步执行**：F10（下一步）、F11（进入子流程）、Shift+F11（跳出）
  - **执行高亮**：当前执行节点黄色脉冲动画（QPropertyAnimation）
  - **变量监视**：底部QDockWidget实时显示变量值变化
  - **即时命令**：调试控制台（QTextEdit）输入Python代码修改变量

  ### 6.2 实时监控大屏（QMainWindow多Dock布局）

  

  复制

  ```
  左侧：任务列表（QTreeWidget）
  ├── 运行中（绿色播放图标）
  ├── 已排队（灰色时钟图标）
  └── 已完成（蓝色对勾）
  
  中间：流程执行动画（节点逐个变黄→变绿/红）
  
  右侧：实时数据
  ├── 当前步骤：节点名称+操作描述
  ├── 已耗时：毫秒级计时器（QElapsedTimer）
  ├── 进度条：百分比+剩余步数
  └── 资源占用：CPU/内存曲线图（QChart）
  
  底部：日志流（QPlainTextEdit，带语法高亮）
  ```

  ------

  ## 七、日志与报表（影刀级审计）

  ### 7.1 执行日志（富文本嵌入）

  - **结构化存储**：SQLite表（task_id, step_id, timestamp, status, screenshot）
  - **多媒体嵌入**：失败步骤自动截图（QScreen.grabWindow）
  - **日志级别**：DEBUG（开发者模式）、INFO（标准）、WARN（警告）、ERROR（失败）
  - **检索功能**：QLineEdit实时过滤 + QDateEdit时间范围筛选

  ### 7.2 数据统计报表（QTableView + ECharts集成）

  - **执行统计**：日/周/月成功率折线图
  - **性能分析**：各节点平均耗时柱状图（识别瓶颈）
  - **错误分布**：饼图按异常类型分类
  - **机器人效率**：多机器人任务量对比
  - **导出功能**：PDF/Excel/HTML报表（QPrinter + pandas）

  ------

  ## 八、应用市场与流程管理（影刀社区复刻）

  ### 8.1 流程商店（QListWidget + 网络请求）

  - **分类标签**：办公自动化、数据采集、电商运营、财务处理
  - **搜索功能**：QLineEdit实时搜索流程名称和描述
  - **导入导出**：.pybot格式（JSON元数据+Python脚本+资源文件ZIP打包）
  - **版本管理**：Git后端集成，右键"查看历史版本"、"回滚到v1.2"

  ### 8.2 流程权限（多用户模式）

  - **角色定义**：管理员（全权限）、开发者（编辑）、执行者（仅运行）
  - **加密存储**：流程文件AES加密（密钥由机器码生成）
  - **使用统计**：每个流程的执行次数、成功率、平均时长

  ------

  ## 九、无人值守模式（完美复刻影刀机器人服务）

  ### 9.1 服务化实现

  Python

  复制

  ```python
  # Windows服务化代码示例（pywin32）
  class RPAWorkerService(win32serviceutil.ServiceFramework):
      _svc_name_ = "PyBotRPA"
      _svc_display_name_ = "PyBot RPA机器人服务"
      
      def SvcDoRun(self):
          scheduler = BackgroundScheduler()
          scheduler.add_jobstore(SQLAlchemyJobStore(url='sqlite:///jobs.db'))
          # 加载所有启用的定时任务
          scheduler.start()
          win32event.WaitForSingleObject(self.hWaitStop, win32event.INFINITE)
  ```

  ### 9.2 静默执行

  - **隐藏窗口**：Playwright headless模式 + PySide6系统托盘（QSystemTrayIcon）
  - **错误通知**：Windows通知中心/邮件/企业微信Webhook
  - **断网续传**：任务状态持久化，重启后自动恢复执行
  - **资源自适应**：CPU占用>80%时自动降低执行频率

  ------

  ## 十、部署与打包（一键安装包）

  ### 10.1 安装程序生成

  bash

  复制

  ```bash
  # Inno Setup脚本自动生成
  - 创建桌面快捷方式
  - 注册右键菜单"用PyBot打开"
  - 写入卸载信息到控制面板
  - 安装完成自动启动机器人服务
  ```

  ### 10.2 跨平台支持

  表格

  复制

  | 平台    | 打包工具                 | 服务化方案      | 系统托盘        |
  | :------ | :----------------------- | :-------------- | :-------------- |
  | Windows | PyInstaller + Inno Setup | Windows Service | QSystemTrayIcon |
  | macOS   | PyInstaller + DMG        | LaunchAgent     | QSystemTrayIcon |
  | Linux   | PyInstaller + DEB/RPM    | systemd         | QSystemTrayIcon |

  ------

  ## 十一、影刀功能对照清单

  表格

  复制

  | 影刀功能         | PySide6实现方案                     | 完成度 |
  | :--------------- | :---------------------------------- | :----- |
  | 可视化拖拽设计   | QGraphicsView + 自定义QGraphicsItem | ★★★★★  |
  | 元素捕获器       | Playwright Inspector + Pywinauto    | ★★★★★  |
  | 定时任务（Cron） | APScheduler + 可视化编辑器          | ★★★★★  |
  | 循环/判断        | 流程图节点 + Python表达式引擎       | ★★★★★  |
  | 变量管理         | QTableView + 数据绑定               | ★★★★★  |
  | Excel自动化      | pandas + openpyxl可视化封装         | ★★★★★  |
  | 日志录屏         | QScreen录制 + OpenCV压缩            | ★★★★☆  |
  | 机器人服务       | pywin32/systemd服务化               | ★★★★★  |
  | 应用市场         | JSON元数据 + ZIP打包                | ★★★★★  |
  | 权限管理         | SQLite用户表 + 流程加密             | ★★★★☆  |

  ------

  ## 启动命令与开发环境

  bash

  复制

  ```bash
  # 开发环境配置
  conda create -n pybot python=3.11
  conda activate pybot
  
  # 核心依赖
  pip install PySide6==6.8.0          # PySide6 LGPL版本
  pip install playwright==1.40.0      # 浏览器自动化
  pip install pywinauto==0.6.8        # 桌面控件识别
  pip install APScheduler==3.10.4     # 定时任务引擎
  pip install pyinstaller==6.3.0      # 打包工具
  pip install pywin32==306            # Windows服务化
  
  # UI设计
  pip install qt-tools                # Qt Designer可视化设计
  
  # 运行
  python main.py --mode=developer     # 开发者模式显示调试信息
  python main.py --mode=service       # 服务化模式无界面
  ```

  ------

  **结论**：本系统通过PySide6强大的图形框架，实现了与影刀RPA高度一致的可视化体验，尤其在定时执行的Cron可视化编辑、多机器人服务化管理、元素智能捕获等核心功能上达到企业级水准。完全基于Python生态的扩展性远超影刀，且支持私有化部署与源码级定制。
